---
title: "mscatch"
#output: html_document
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mscatch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
 library(magrittr)
```

When working with `mscatch` you will need to:

*   [Assemble data](1dataNeeds.html) for use in the package
*   [Aggregate the data](2aggregationRules.html) based on a set of rules
*   Use length-weight relationships to [expand the catch](3catchExpansion.html) to weights using the length samples

## Example

Assuming you have assembled the data (for a sample data set see,  [`get_sample_data`](../reference/get_sample_data.html)), the next step is determine how you would like to aggregate the data and how you would like to deal with YEARs/QTRs with missing length samples. 

### Aggregate the data

The following example implements the following decisions:

* Assigns the name of species (`speciesName = "Haddock"`)

* Aggregates landings over QTR year to YEARly data and combines all length samples to same level of aggregation (`aggregate_to = "YEAR"`).

* Uses gear types (NEGEARs) which contribute the most to total landings. Uses a cumulative landings threshold of 90% to select gears. Other gears will be aggregated into an "other Gear" category (`landingThresholdGear = 0.9`)

* Assigns other gears to code "998" (`otherGear = "998"`)

* Borrows length samples from nearest neighbor, whether by QTR, YEAR, or NEGEAR (`borrowLengths = T`). 

* Minimum number of length samples required when borrowing samples from other NEGEARs, QTRs, or YEARs (`nLengthSamples = 1`)

* Assigns an output folder (`outputDir=here::here("output/Haddock")`)

* Assigns a name to the log file produced (`logfile = "logfile.txt"`)


```{r , echo =T, eval = F}
 aggregatedData <- mscatch::aggregate_landings(landingsData,
                                               lengthData,
                                               outputDir=here::here("output/Groundfish"),
                                               speciesName = "Haddock"
                                               landingThresholdGear = 0.9,
                                               nLengthSamples = 1,
                                               aggregate_to = "YEAR",
                                               borrowLengths = T,
                                               otherGear = "998",
                                               logfile = "logfile.txt"
                                               outputPlots = T)
```

At this point,`aggregateData` contains length samples for every combination of YEAR, NEGEAR, MARKET_CODE. All decisions made regarding gear type selection, market code selection, and which YEAR length samples were borrowed from are recorded in the `logfile`. If `outputPlots=T` a suite of plots are also output in the `outputDir`.

### Expand the catch

To expand the catch to weight-by-length a length-weight key is required. This is achieved by obtaining parameter values that satisfy the [length-weight relationship](3catchExpansion.html). This can be obtained in one of two ways: 

* Pull parameter values from Survey database (svdbs) using function [`get_length_weight`](https://noaa-edab.github.io/survdat/reference/get_length_weight.html) function from the [`survdat`](https://noaa-edab.github.io/survdat/index.html) package.

or

* Pull raw length-weight data and fit own model. The bottom trawl survey data is used (for this example). A series of nested length-weight models are then fit to the data.

The data is pulled using the function [`get_length_weight_data`](https://noaa-edab.github.io/survdat/reference/get_length_weight_data.html) from the [`survdat`](https://noaa-edab.github.io/survdat/) package and fit using `mscatch::fit_length_weight()`

```{r lw, echo =T , eval = F}
# Permissions and credentials are required to conect to the database
channel <- dbutils::connect_to_database("server","user")
# Haddock data are pulled (SVSPP = 74)
lengthWeightData <- survdat::get_length_weight_data(channel,year="all", species=74)
# Length-Weight models are thenn fit
fits <- mscatch::fit_length_weight(lengthWeightData$data,speciesName,outputDir,logfile="logfile.txt")

```

* The fitted model is then used to expand the catch. This is achieved by using `mscatch::expand_landings_to_lengths()`

```{r expand, echo = T, eval = F}
  expandedLandings <- mscatch::expand_landings_to_lengths(aggregatedData$landings,aggregatedData$lengthData,fits$paramsH0) %>%
    dplyr::mutate(speciesName = speciesName)

```

The resulting data will look like this

```{r expdata,echo=F,eval=T}

sl <- readRDS(here::here("data-raw/data/sampleExpanded.RDS")) 
sl
```
where the `weight` column represents the weight (metric tons) of all fish of a given `LENGTH`

